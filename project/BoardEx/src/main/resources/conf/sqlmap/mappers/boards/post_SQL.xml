<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.test.board.boards.service.impl.PostMapper">
	<resultMap id="postResult" type="PostVO" />

	<!-- 게시글 목록 조회 -->
	<select id="selectPostList" parameterType="PostVO" resultMap="postResult">
		<![CDATA[
		/* post_SQL.selectPostList */
		SELECT
			P.IDX, P.BOARD_IDX, B.NAME AS BOARD_NAME, P.TITLE, P.CONTENT,
			P.WRITER_IDX, A.ACC_NAME AS WRITER_NAME, P.COMMENT_CNT, P.IS_DEL, P.NOTE,
			DATE_FORMAT(P.WRITE_DT, '%Y-%m-%d %H:%i') AS WRITE_DT,
			DATE_FORMAT(P.MODIFY_DT, '%Y-%m-%d %H:%i') AS MODIFY_DT
		FROM
			POST AS P
			LEFT OUTER JOIN BOARD AS B
			ON (P.BOARD_IDX = B.IDX)
			LEFT OUTER JOIN ACCOUNT AS A
			ON (P.WRITER_IDX = A.IDX)
		WHERE
			B.IS_DEL = 'N'
			AND P.IS_DEL = 'N'
		]]>
		<if test='boardIdx != 0'>
    	<![CDATA[
			AND P.BOARD_IDX = #{boardIdx}
		]]>
		</if>
		<if test='searchTitle != null and searchTitle != ""'>
    	<![CDATA[
			AND P.TITLE LIKE CONCAT('%',#{searchTitle},'%')
    	]]>
		</if>
		<if test='searchWriterName != null and searchWriterName != ""'>
    	<![CDATA[
			AND A.ACC_NAME LIKE CONCAT('%',#{searchWriterName},'%')
    	]]>
		</if>
		<![CDATA[
		ORDER BY
			P.WRITE_DT DESC
		LIMIT #{startRownum}, #{cntPerPage}
		]]>
	</select>

	<!-- 게시글 목록 총 갯수 -->
	<select id="selectPostListTotalCnt" parameterType="PostVO" resultType="int">
		<![CDATA[
		/* post_SQL.selectPostListTotalCnt */
		SELECT
			COUNT(*)
		FROM
			POST AS P
			LEFT OUTER JOIN BOARD AS B
			ON (P.BOARD_IDX = B.IDX)
			LEFT OUTER JOIN ACCOUNT AS A
			ON (P.WRITER_IDX = A.IDX)
		WHERE
			B.IS_DEL = 'N'
			AND P.IS_DEL = 'N'
		]]>
		<if test='boardIdx != 0'>
    	<![CDATA[
			AND P.BOARD_IDX = #{boardIdx}
		]]>
		</if>
		<if test='searchTitle != null and searchTitle != ""'>
    	<![CDATA[
			AND P.TITLE LIKE CONCAT('%',#{searchTitle},'%')
    	]]>
		</if>
		<if test='searchWriterName != null and searchWriterName != ""'>
    	<![CDATA[
			AND A.ACC_NAME LIKE CONCAT('%',#{searchWriterName},'%')
    	]]>
		</if>
	</select>

	<!-- 게시글 조회 -->
	<select id="selectPost" parameterType="PostVO" resultMap="postResult">
		<![CDATA[
		/* post_SQL.selectPost */
		SELECT
			P.IDX, P.BOARD_IDX, B.NAME AS BOARD_NAME, P.TITLE, P.CONTENT,
			P.WRITER_IDX, A.ACC_NAME AS WRITER_NAME, P.COMMENT_CNT, P.IS_DEL, P.NOTE,
			DATE_FORMAT(P.WRITE_DT, '%Y-%m-%d %H:%i') AS WRITE_DT,
			DATE_FORMAT(P.MODIFY_DT, '%Y-%m-%d %H:%i') AS MODIFY_DT
		FROM
			POST AS P
			LEFT OUTER JOIN BOARD AS B
			ON (P.BOARD_IDX = B.IDX)
			LEFT OUTER JOIN ACCOUNT AS A
			ON (P.WRITER_IDX = A.IDX)
		WHERE
			P.BOARD_IDX = #{boardIdx}
			AND P.IDX = #{idx}
			AND B.IS_DEL = 'N'
			AND P.IS_DEL = 'N'
		]]>
	</select>

	<!-- 게시글 등록 -->
	<insert id="insertPost" parameterType="PostVO">
		<![CDATA[
		/* post_SQL.insertPost */
		INSERT INTO POST
		(
			BOARD_IDX, TITLE, CONTENT, WRITER_IDX, NOTE
		)
		VALUES
		(
			#{boardIdx}, #{title}, #{content}, #{writerIdx}, #{note, jdbcType=VARCHAR}
		)
		]]>
	</insert>
	
	<!-- 게시글 수정 -->
	<update id="updatePost" parameterType="PostVO">
		<![CDATA[
		/* post_SQL.updatePost */
		UPDATE
			POST
		SET
			TITLE = #{title},
			CONTENT = #{content},
			NOTE = #{note, jdbcType=VARCHAR},
			MODIFY_DT = NOW()
		WHERE
			BOARD_IDX = #{boardIdx}
			AND IDX = #{idx}
		]]>
	</update>
	
	<!-- 게시글 삭제 -->
	<update id="deletePost" parameterType="PostVO">
		<![CDATA[
		/* post_SQL.deletePost */
		UPDATE
			POST
		SET
			IS_DEL = 'Y',
			MODIFY_DT = NOW()
		WHERE
			BOARD_IDX = #{boardIdx}
			AND IDX = #{idx}
		]]>
	</update>

</mapper>